// To migrate after schema change: DATABASE_URL=postgresql://cokingtins1:drpeppa1212@localhost:5432/otf_db npx prisma migrate dev --nameâ€¦
// To generate new prisma client:  DATABASE_URL=postgresql://cokingtins1:drpeppa1212@localhost:5432/otf_db npx prisma generate

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tokens   OAuthToken[]
  workouts Workout[]
}

model OAuthToken {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  accessToken  String // Encrypted
  refreshToken String // Encrypted
  expiresAt    DateTime
  scope        String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
}

model Workout {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Email metadata
  gmailMessageId String   @unique
  emailDate      DateTime

  // Class metadata
  classTime       String? // e.g., "10:45 AM"
  studioLocation  String? // e.g., "New Albany, OH"
  classInstructor String? // e.g., "Lamara Ambler"

  // Workout metrics
  caloriesBurned Int?
  splatPoints    Int?
  avgHeartRate   Int?
  peakHeartRate  Int?
  steps          Int?

  // Treadmill data
  treadmillDistance    Float? // miles
  treadmillTime        Int? // seconds
  treadmillAvgSpeed    Float? // mph
  treadmillMaxSpeed    Float? // mph
  treadmillAvgIncline  Float? // percent
  treadmillMaxIncline  Float? // percent
  treadmillAvgPace     Int? // seconds per mile
  treadmillFastestPace Int? // seconds per mile
  treadmillElevation   Float? // feet

  // Rowing data (if present)
  rowingDistance      Float? // meters
  rowingTime          Int? // seconds
  rowingAvgWattage    Int? // watts
  rowingMaxWattage    Int? // watts
  rowingAvgSpeed      Float? // km/h
  rowingMaxSpeed      Float? // km/h
  rowing500mSplit     Int? // seconds
  rowingMax500mSplit  Int? // seconds (fastest/best)
  rowingAvgStrokeRate Float? // strokes per minute

  // Additional metrics
  activeMinutes       Int?
  minutesInGrayZone   Int?
  minutesInBlueZone   Int?
  minutesInGreenZone  Int?
  minutesInOrangeZone Int?
  minutesInRedZone    Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Raw data for re-parsing (at end for readability)
  rawHtml String

  @@index([userId, emailDate])
}

model RedditPost {
  id                      String   @id @default(cuid())
  redditId                String   @unique
  permalink               String
  title                   String
  author                  String
  subreddit               String
  createdUtc              DateTime
  selftext                String?
  selftextHtml            String?
  url                     String?
  score                   Int?
  upvoteRatio             Float?
  numComments             Int?
  flair                   String?
  rawJson                 String
  workoutCommentId        String?
  workoutCommentPermalink String?
  workoutContent          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([author, createdUtc])
  @@index([subreddit, createdUtc])
  @@index([author, subreddit, createdUtc(sort: Desc)])
}

model ScrapedContent {
  id        Int      @id @default(autoincrement())
  title     String?
  content   String?
  url       String
  scrapedAt DateTime @default(now())
}
